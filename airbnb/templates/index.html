<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Mapbox Harita ve Ä°statistikler</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script type="text/javascript" src="http://www.chartjs.org/assets/Chart.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <style>
        #map {
            position: absolute;
            top: 60px;
            bottom: 0;
            width: 70%;
        }
        #stats {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            width: 30%;
            padding: 10px;
            background-color: #f1f1f1;
        }
        #navbar{
            position: absolute;
            width: 70%;
            font-size: larger;
            padding-right: 30px;
            padding-left: 30px;
        }
        #filter{
            padding-top: 10px;
            margin-left: 50px;
            font-size: 18px;

        }
        .dropdown-menu {
            max-height: 280px;
            overflow-y: auto;
        }

    </style>
</head>
<body>
<div>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark" id="navbar">
        <a class="navbar-brand" href="#" id="set_bbox">ISTANBUL AIRBNB PREDICTION APP</a>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="#" id="heatmapBtn">Heatmap</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="clusterBtn">Cluster</a>
                </li>
                <li class="nav-item" id="filter">
                    <div>
                        <select id="select-district">
                            <option selected disabled id="selected">Filter by District</option>
                                {% for labels in neighbourhoods_labels %}
                                    <option value="{{ labels }}">{{ labels }}</option>
                                {% endfor %}
                        </select>
                    </div>
                </li>
            </ul>
        </div>
    </nav>
</div>
<div id='map'>
</div>

<div id='stats'>
    <h3 style="text-align:center">Statistics</h3>
    <canvas id="accommodates_price_chart"></canvas>
    <hr>
    <canvas id="room_type_chart"></canvas>
</div>
<script>
        mapboxgl.accessToken = '{{ mapbox_access_token }}';

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/boratutumluer/clh0i109u00dl01qtcq4mee7s',
            center: [29.02573, 41.08384],
            zoom: 3,
            maxBounds: [[27.965767, 40.801789],[29.963703, 41.585417]]
        });

        map.fitBounds([[27.965767, 40.801789],[29.963703, 41.585417]])

        function highlightNeighbourhood(district) {
          if (map.getSource("neighbourhood_highlight_source")) {
            map.setLayoutProperty("neighbourhood_highlight", "visibility", "visible");
            map
              .getSource("neighbourhood_highlight_source")
              .setData(
                neighbour_geojson.features.filter(
                  (i) => i.properties.neighbourhood === district
                )[0]
              );
          } else {
            map.addSource("neighbourhood_highlight_source", {
              type: "geojson",
              data: neighbour_geojson.features[0],
            });
            map.addLayer({
              id: "neighbourhood_highlight",
              type: "line",
              source: "neighbourhood_highlight_source",
              paint: {
                "line-color": "white",
                "line-opacity": 0.75,
                "line-width": 2,
              },
            });
            map.setLayoutProperty("neighbourhood_highlight", "visibility", "none");
          }
        }

        function updateRoomChartData(){
            roomTypeChart.data.datasets[0].data = [14765, 194, 4563, 2000];
            roomTypeChart.update()
        }

        function updateCapacityChartData(){
            capacityChart.data.datasets[0].data = [14765, 194, 4563, 2000];
            capacityChart.update();
        }



                                        <!--        NEIGHBOURHOOD-->
        const neighbour_geojson =  JSON.parse({{ neighbourhoods|tojson|safe }});
        map.on('load', function() {
            map.addSource('neighbourhoods', {
                type: 'geojson',
                data: neighbour_geojson
            });
            map.addLayer({
                id: 'neighbourhoods-layer',
                type: 'fill',
                source: 'neighbourhoods',
                paint: {
                    'fill-color': 'white',
                    'fill-opacity': 0.2
                },
            });
            map.addLayer({
                id: "neighbourhoods-label",
                type: "symbol",
                source: "neighbourhoods",
                layout: {
                "text-field": ["get", "neighbourhood"],
                "text-variable-anchor": ["top", "bottom", "left", "right"],
                "text-radial-offset": 0.5,
                "text-justify": "auto",
                "icon-image": ["concat", ["get", "icon"], "-15"],
                "text-size": 10,
                }
            });
            // highlight layer is initialized!!
            highlightNeighbourhood('');
        });

                                        <!--        POINTS-->
        const Points = {{ points|tojson|safe }}
        map.on('load', function() {
            map.addSource('point', {
              'type': 'geojson',
              'data': {
                'type': 'FeatureCollection',
                'features': Points.map(function(point) {
                  return {
                    'type': 'Feature',
                    'properties' : {'label' : point[1], 'segment': point[2]},
                    'geometry': {
                      'type': 'Point',
                      'coordinates': point[0]
                    }
                  };
                })
              },
                cluster: true,
                clusterMaxZoom: 14,
                clusterRadius: 50
            });

            map.addLayer({
                id: 'clusters',
                type: 'circle',
                source: 'point',
                filter: ['has', 'point_count'],
                paint: {
                    'circle-color': [
                        'step',
                        ['get', 'point_count'],
                        '#146C94',
                        100,
                        '#EBB02D',
                        750,
                        '#E74646'
                    ],
                    'circle-radius': [
                        'step',
                        ['get', 'point_count'],
                        20,
                        100,
                        30,
                        750,
                        40
                    ]
                }
            });

            map.addLayer({
                id: 'cluster-count',
                type: 'symbol',
                source: 'point',
                filter: ['has', 'point_count'],
                layout: {
                    'text-field': ['get', 'point_count_abbreviated'],
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 12
                }
            });

            map.addLayer({
                id: 'unclustered-point',
                type: 'circle',
                source: 'point',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': '#11b4da',
                    'circle-radius': 3,
                    'circle-stroke-width': 1,
                    'circle-stroke-color': 'black'
                }
            });

            map.addLayer({
                id: 'all-points',
                type: 'circle',
                source: 'point',
                paint: {
                    'circle-color': '#11b4da',
                    'circle-radius': 3,
                    'circle-stroke-width': 1,
                    'circle-stroke-color': 'black'
                }
            });

            map.addSource('heat_points', {
              'type': 'geojson',
              'data': {
                'type': 'FeatureCollection',
                'features': Points.map(function(point) {
                    return {
                        'type': 'Feature',
                        'properties' : {'label' : point[1], 'segment': point[2]},
                        'geometry': {
                        'type': 'Point',
                        'coordinates': point[0]
                        }
                    };
                })
              },
            });


            map.addLayer({
              id: "heatmap_layer",
              type: "heatmap",
              source: "heat_points",
              paint: {
                // Increase the heatmap weight based on frequency and property magnitude
                "heatmap-weight": ["interpolate", ["linear"], ["get", "mag"], 0, 0, 6, 1],
                // Increase the heatmap color weight weight by zoom level
                // heatmap-intensity is a multiplier on top of heatmap-weight
                "heatmap-intensity": ["interpolate", ["linear"], ["zoom"], 0, 1, 19, 3],
                // Color ramp for heatmap.  Domain is 0 (low) to 1 (high).
                // Begin color ramp at 0-stop with a 0-transparancy color
                // to create a blur-like effect.
                "heatmap-color": [
                  "interpolate",
                  ["linear"],
                  ["heatmap-density"],
                  0,
                  "rgba(33,102,172,0)",
                  0.2,
                  "rgb(103,169,207)",
                  0.4,
                  "rgb(209,229,240)",
                  0.6,
                  "rgb(253,219,199)",
                  0.8,
                  "rgb(239,138,98)",
                  1,
                  "rgb(178,24,43)",
                ],
                // Adjust the heatmap radius by zoom level
                "heatmap-radius": ["interpolate", ["linear"], ["zoom"], 0, 2, 19, 20],
                // Transition from heatmap to circle layer by zoom level
                "heatmap-opacity": ["interpolate", ["linear"], ["zoom"], 7, 1, 19, 0],
              },
            });
            map.setLayoutProperty('heatmap_layer','visibility','none');
            map.setLayoutProperty('all-points','visibility','none');

        });



                                        <!--        NEIGHBOURHOOD FILTER-->
        const neighbourhoods_bbox = {{ neighbourhoods_bbox|tojson|safe }}
        document.getElementById('select-district').addEventListener('change', (event) => {

            const district = event.target.value;

            map.setFilter('unclustered-point', ['==', ['get', 'label'], district]);

            map.setPaintProperty('unclustered-point', 'circle-color', {
                "property": "segment",
                "type": "categorical",
                "stops": [
                  [1, "red"],
                  [2, "green"],
                  [3, "blue"],
                  [4, "yellow"],
                  [5, "purple"],
                  [6, "orange"],
                  [7, "white"],
                  [8, "brown"]
                  ],
                "default": "gray"
            });

            highlightNeighbourhood(district);
            const district_bbox = neighbourhoods_bbox[district];
            map.fitBounds(district_bbox, {
                maxZoom: 14,
                duration: 2000
            });

            const style = map.getStyle()
            style.sources.point.cluster = false
            map.setStyle(style)
        });

                                                    <!-- HEATMAP -->
        const heatmapButton = document.querySelector('#heatmapBtn');
        heatmapButton.addEventListener('click',(event)=>{
            if(event.target.innerText === 'Heatmap'){
                event.target.innerText = 'Point Cloud';
                map.setLayoutProperty('heatmap_layer','visibility','visible');
                map.setLayoutProperty('unclustered-point','visibility','none');
                map.setLayoutProperty('clusters','visibility','none');
                map.setLayoutProperty('cluster-count','visibility','none');
                map.setLayoutProperty('all-points','visibility','none');

            } else {
                event.target.innerText = 'Heatmap';
                map.setLayoutProperty('heatmap_layer','visibility','none');
                map.setLayoutProperty('unclustered-point','visibility','visible');
                map.setLayoutProperty('clusters','visibility','visible');
                map.setLayoutProperty('cluster-count','visibility','visible');
                map.setLayoutProperty('all-points','visibility','none');
                const style = map.getStyle()
                style.sources.point.cluster = true
                map.setStyle(style)
            }
        })

                                                            <!-- CLUSTER -->
<!--        const clusterButton = document.querySelector('#clusterBtn');-->
<!--        heatmapButton.addEventListener('click',(event)=>{-->
<!--            if(event.target.innerText === 'Cluster'){-->
<!--                event.target.innerText = 'All';-->
<!--                map.setLayoutProperty('heatmap_layer','visibility','visible');-->
<!--                map.setLayoutProperty('unclustered-point','visibility','none');-->
<!--                map.setLayoutProperty('clusters','visibility','none');-->
<!--                map.setLayoutProperty('cluster-count','visibility','none');-->

<!--            } else {-->
<!--                event.target.innerText = 'Heatmap';-->
<!--                map.setLayoutProperty('heatmap_layer','visibility','none');-->
<!--                map.setLayoutProperty('unclustered-point','visibility','visible');-->
<!--                map.setLayoutProperty('clusters','visibility','visible');-->
<!--                map.setLayoutProperty('cluster-count','visibility','visible');-->
<!--                const style = map.getStyle()-->
<!--                style.sources.point.cluster = true-->
<!--                map.setStyle(style)-->
<!--            }-->
<!--        })-->


                                                    <!-- LIMIT -->
        document.getElementById('set_bbox').addEventListener('click', () => {
            map.fitBounds([[27.965767, 40.801789],[29.963703, 41.585417]])
            map.setLayoutProperty('neighbourhood_highlight','visibility','none');
            map.setLayoutProperty('all-points','visibility','none');

            const style = map.getStyle()
            style.sources.point.cluster = true
            map.setStyle(style)

        });







































                                        <!--        STATISTICS-->
        var accommodates_price = document.getElementById('accommodates_price_chart').getContext('2d');
        const capacityChart = new Chart(accommodates_price, {
            type: "line",
            data: {
                labels: {{accommodates}},
                datasets: [{
                    label: 'capacity',
                    backgroundColor: "rgba(0,0,255,1.0)",
                    borderColor: "rgba(0,0,255,0.1)",
                    data: {{price}},
                    fill: false
                }]
            },
            options: {
                title: {
                    display: true,
                    text: "Prices by Capacity"
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        },
                        scaleLabel: {
                            display: true,
                            labelString: "Price in TL"
                        }
                    }],
                    xAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: "Capacity"
                        }
                    }]
                },
                  legend: {
                     display: false
                        }
            }
        });

       var room_type_ = document.getElementById('room_type_chart').getContext('2d');
         const roomTypeChart = new Chart(room_type_, {
            type: "horizontalBar",
            data: {
                labels: ['Entire home/apt', 'Private room', 'Hotel room', 'Shared room'],
                datasets: [{
                    backgroundColor: ["rgb(0, 35, 91)", "rgb(226, 24, 24)", "rgb(255, 221, 131)", "rgb(152, 223, 214)"],
                    borderColor: "rgba(0,0,255,0.1)",
                    data: [14765, 4563, 194, 100],
                    fill: false
                }]
            },
            options: {
                title: {
                    display: true,
                    text: "Room Type"
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        },
                    }],
                    xAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: "Count"
                        }
                    }]
                },
                legend: {
                     display: false
                        }
            }
        });
</script>
</body>
</html>
